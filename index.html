<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Hub - æ™ºèƒ½å®¶å±…æ§åˆ¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 30%;
            background: white;
            padding: 0;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-top {
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-menu {
            padding: 8px 0;
        }

        .sidebar-log {
            height: 485px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            border-top: 1px solid #e8e8e8;
            flex-shrink: 0;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            margin: 4px 16px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
        }

        .sidebar-item:hover {
            background: #f5f5f5;
            color: #1890ff;
            border-color: #bfbfbf;
        }

        .sidebar-item.active {
            background: white;
            color: #1890ff;
            border: 1px solid #1890ff;
            border-radius: 999px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            width: 70%;
            padding: 32px;
            overflow-y: auto;
            position: relative;
            margin-left: 30%;
        }

        /* é¡¶éƒ¨å¯¼èˆªèœå• */
        .top-nav-menu {
            position: absolute;
            top: 32px;
            right: 32px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .top-nav-item {
            padding: 8px 16px;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .top-nav-item:hover {
            background: #f5f5f5;
            border-color: #bfbfbf;
            color: #1890ff;
        }

        .top-nav-item.active {
            background: white;
            border-color: #1890ff;
            color: #1890ff;
        }

        .greeting {
            font-size: 24px;
            font-weight: 500;
            color: #333;
            margin-bottom: 32px;
        }

        /* æ§åˆ¶è®¾å¤‡çŠ¶æ€ */
        .control-device-section {
            background: #f8f9fa;
            border-radius: 1px;
            padding: 16px;
            margin: 10px;
            margin-bottom: 1px;
        }

        .control-device-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .control-device-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .refresh-btn {
            background: white;
            color: #333;
            border: 1px solid #d9d9d9;
            padding: 6px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .refresh-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #bfbfbf;
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .add-btn {
            padding: 8px 16px;
            background: white;
            color: #333;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #f5f5f5;
            border-color: #1890ff;
            color: #1890ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
        }

        .add-btn:active {
            transform: translateY(0);
        }

        .control-device-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f0f0f0;
            flex-shrink: 0;
        }

        .status-indicator.connected {
            background: #52c41a;
            box-shadow: 0 0 6px rgba(82, 196, 26, 0.4);
        }

        .status-indicator.disconnected {
            background: #ff4d4f;
        }

        .status-text {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .device-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e8e8e8;
            font-size: 11px;
            color: #999;
            line-height: 1.4;
        }

        /* æ‰‹æœºå±å¹•æ˜¾ç¤ºåŒºåŸŸ */
        .phone-screen-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            margin-bottom: 16px;
            height: 300px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .phone-screen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .phone-screen-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .phone-screen-toggle {
            background: white;
            color: #333;
            border: 1px solid #d9d9d9;
            padding: 6px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .phone-screen-toggle:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #bfbfbf;
        }

        .phone-screen-toggle:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .phone-screen-container {
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            flex: 1;
            min-height: 0;
            display: none;
        }

        .phone-screen-container.show {
            display: block;
        }

        .phone-screen-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .phone-screen-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #999;
            font-size: 12px;
            text-align: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        /* è®¾å¤‡ç½‘æ ¼ */
        .devices-section {
            margin-bottom: 40px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .device-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .device-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .device-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .device-app-name {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .device-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border-radius: 8px;
        }

        .device-icon-emoji {
            font-size: 32px;
        }

        .device-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            background: #f0f0f0;
            color: #666;
        }

        .device-status.active {
            background: #e6f7ff;
            color: #1890ff;
        }

        .device-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .device-info {
            font-size: 14px;
            color: #999;
        }

        .device-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .device-action-btn {
            flex: 1;
            padding: 8px 12px;
            background: white;
            color: #333;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .device-action-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #bfbfbf;
            transform: translateY(-1px);
        }

        .device-action-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .device-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* æ‰«åœ°æœºç‰¹æ®Šæ ·å¼ */
        .device-card.cleaning {
            border: 2px solid #1890ff;
        }

        .device-card.cleaning .device-status {
            background: #1890ff;
            color: white;
        }

        /* æ—¥å¿—è¾“å‡ºåŒºåŸŸ */
        .log-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .log-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .log-clear-btn {
            background: #f5f5f5;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.3s;
        }

        .log-clear-btn:hover {
            background: #e8e8e8;
        }

        .stream-output {
            flex: 1;
            padding: 12px 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.5;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 0;
        }

        .stream-output .line {
            margin: 2px 0;
        }

        .stream-output .line.info {
            color: #4ec9b0;
        }

        .stream-output .line.error {
            color: #f48771;
        }

        .stream-output .line.success {
            color: #4ec9b0;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* è®¾å¤‡ç®¡ç†æ ·å¼ */
        .device-management-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .device-management-info {
            flex: 1;
        }

        .device-management-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-management-details {
            font-size: 13px;
            color: #999;
            margin-top: 4px;
        }

        .device-management-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .action-btn.edit {
            background: white;
            color: #333;
        }

        .action-btn.edit:hover {
            background: #f5f5f5;
            border-color: #bfbfbf;
        }

        .action-btn.delete {
            background: #ff4d4f;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        /* è®¾å¤‡ç¼–è¾‘æ¨¡æ€æ¡† */
        .device-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .device-modal.show {
            display: flex;
        }

        .device-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            padding: 24px;
        }

        .device-modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #1890ff;
        }

        .icon-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        .icon-preview img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Actions ç¼–è¾‘åŒºåŸŸ */
        #actions-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
        }

        .action-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
        }

        .action-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            font-size: 14px;
        }

        .action-row textarea {
            flex: 2;
            padding: 8px 12px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }

        .action-row .remove-action-btn {
            padding: 8px 12px;
            background: #ff4d4f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            flex-shrink: 0;
        }

        .action-row .remove-action-btn:hover {
            opacity: 0.8;
        }

        .add-action-btn {
            padding: 8px 16px;
            background: white;
            color: #666;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: all 0.3s;
        }

        .add-action-btn:hover {
            background: #f5f5f5;
            border-color: #bfbfbf;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-btn.cancel {
            background: white;
            color: #666;
        }

        .modal-btn.cancel:hover {
            background: #f5f5f5;
            border-color: #bfbfbf;
        }

        .modal-btn.save {
            background: white;
            color: #333;
        }

        .modal-btn.save:hover {
            background: #f5f5f5;
            border-color: #bfbfbf;
        }
    </style>
</head>
<body>
    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-top">
                <!-- æ§åˆ¶è®¾å¤‡çŠ¶æ€ -->
                <div class="control-device-section">
                    <div class="control-device-header">
                        <div class="control-device-title">æ§åˆ¶è®¾å¤‡çŠ¶æ€</div>
                        <button class="refresh-btn" onclick="checkControlDevice()" id="refresh-btn">
                            <span>ğŸ”„</span>
                            <span>åˆ·æ–°</span>
                        </button>
                    </div>
                    <div class="control-device-status">
                        <div class="status-indicator" id="status-indicator"></div>
                        <div class="status-text" id="status-text">ç‚¹å‡»åˆ·æ–°æ£€æµ‹</div>
                    </div>
                    <div class="device-details" id="device-details"></div>
                </div>

                <!-- æ‰‹æœºå±å¹•æ˜¾ç¤º -->
                <div class="phone-screen-section">
                    <div class="phone-screen-header">
                        <div class="phone-screen-title">æ‰‹æœºå±å¹•</div>
                        <button class="phone-screen-toggle" onclick="togglePhoneScreen()" id="phone-screen-toggle">
                            <span>ğŸ“±</span>
                            <span id="phone-screen-toggle-text">å¼€å§‹</span>
                        </button>
                    </div>
                    <div class="phone-screen-container" id="phone-screen-container">
                        <img class="phone-screen-image" id="phone-screen-image" alt="æ‰‹æœºå±å¹•" onerror="this.parentElement.innerHTML='<div class=\'phone-screen-placeholder\'>æ— æ³•è·å–å±å¹•æˆªå›¾<br>è¯·ç¡®ä¿æ‰‹æœºå·²è¿æ¥</div>'">
                    </div>
                    <div class="phone-screen-placeholder" id="phone-screen-placeholder">ç‚¹å‡»"å¼€å§‹"æŒ‰é’®æ˜¾ç¤ºæ‰‹æœºå±å¹•</div>
                </div>

            </div>

            <!-- æ‰§è¡Œæ—¥å¿—åŒºåŸŸ -->
            <div class="sidebar-log">
                <div class="log-header">
                    <div class="log-title" id="log-title">æ‰§è¡Œæ—¥å¿—</div>
                    <button class="log-clear-btn" onclick="clearLog()">æ¸…ç©º</button>
                </div>
                <div class="stream-output" id="stream-output"></div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶éƒ¨å¯¼èˆªèœå• -->
            <div class="top-nav-menu">
                <div class="top-nav-item active" id="nav-control-panel">
                    <span>ğŸ </span>
                    <span>æ§åˆ¶é¢æ¿</span>
                </div>
                <div class="top-nav-item" id="nav-schedule-management">
                    <span>â°</span>
                    <span>å®šæ—¶ä»»åŠ¡</span>
                </div>
                <div class="top-nav-item" id="nav-device-management">
                    <span>ğŸ’¡</span>
                    <span>è®¾å¤‡ç®¡ç†</span>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿é¡µé¢ -->
            <div id="control-panel-page">
                <div class="greeting">IoT Hub</div>

                <!-- å¸¸ç”¨è®¾å¤‡ -->
                <div class="devices-section">
                    <div class="section-title">å¸¸ç”¨è®¾å¤‡</div>
                    <div class="devices-grid" id="devices-grid">
                        <!-- è®¾å¤‡å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>

            <!-- å®šæ—¶ä»»åŠ¡é¡µé¢ -->
            <div id="schedule-management-page" style="display: none;">
                <div class="greeting">å®šæ—¶ä»»åŠ¡</div>
                
                <div class="devices-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="font-size: 18px; font-weight: 600;">ä»»åŠ¡åˆ—è¡¨</div>
                        <button class="add-btn" onclick="showAddScheduleModal()">
                            <span>â•</span>
                            <span>æ·»åŠ ä»»åŠ¡</span>
                        </button>
                    </div>
                    
                    <div id="schedule-list"></div>
                </div>
            </div>

            <!-- è®¾å¤‡ç®¡ç†é¡µé¢ -->
            <div id="device-management-page" style="display: none;">
                <div class="greeting">è®¾å¤‡ç®¡ç†</div>
                
                <div class="devices-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="section-title">è®¾å¤‡åˆ—è¡¨</div>
                        <button class="add-btn" onclick="showAddDeviceModal()">
                            <span>â•</span>
                            <span>æ·»åŠ è®¾å¤‡</span>
                        </button>
                    </div>
                    <div id="device-management-list">
                        <!-- è®¾å¤‡åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å®šæ—¶ä»»åŠ¡ç¼–è¾‘/æ·»åŠ æ¨¡æ€æ¡† -->
    <div class="device-modal" id="schedule-modal">
        <div class="device-modal-content">
            <div class="device-modal-header" id="schedule-modal-title">æ·»åŠ å®šæ—¶ä»»åŠ¡</div>
            <form id="schedule-form">
                <input type="hidden" id="schedule-id-input">
                <div class="form-group">
                    <label>ä»»åŠ¡åç§° *</label>
                    <input type="text" id="schedule-name-input" placeholder="ä¾‹å¦‚: æ—©ä¸Šæ‰“å¼€ç©ºè°ƒ" required>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©è®¾å¤‡ *</label>
                    <select id="schedule-device-select" required onchange="loadDeviceActions()">
                        <option value="">è¯·é€‰æ‹©è®¾å¤‡...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ“ä½œ *</label>
                    <select id="schedule-action-select" required>
                        <option value="">è¯·å…ˆé€‰æ‹©è®¾å¤‡...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‰§è¡Œæ—¶é—´ *</label>
                    <input type="time" id="schedule-time-input" required>
                </div>
                <div class="form-group">
                    <label>é‡å¤æ‰§è¡Œ</label>
                    <select id="schedule-repeat-input">
                        <option value="once">ä»…ä¸€æ¬¡</option>
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯å‘¨</option>
                        <option value="weekdays">å·¥ä½œæ—¥ (å‘¨ä¸€è‡³å‘¨äº”)</option>
                        <option value="weekends">å‘¨æœ« (å‘¨å…­ã€å‘¨æ—¥)</option>
                    </select>
                </div>
                <div class="form-group" id="weekday-selector" style="display: none;">
                    <label>é€‰æ‹©æ˜ŸæœŸå‡  *</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="0"> å‘¨æ—¥
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="1"> å‘¨ä¸€
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="2"> å‘¨äºŒ
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="3"> å‘¨ä¸‰
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="4"> å‘¨å››
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="5"> å‘¨äº”
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px;">
                            <input type="checkbox" name="weekday" value="6"> å‘¨å…­
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="schedule-enabled-input" checked>
                        å¯ç”¨ä»»åŠ¡
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="closeScheduleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="modal-btn save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è®¾å¤‡ç¼–è¾‘/æ·»åŠ æ¨¡æ€æ¡† -->
    <div class="device-modal" id="device-modal">
        <div class="device-modal-content">
            <div class="device-modal-header" id="device-modal-title">æ·»åŠ è®¾å¤‡</div>
            <form id="device-form">
                <input type="hidden" id="device-id-input">
                <div class="form-group">
                    <label>è®¾å¤‡åç§° *</label>
                    <input type="text" id="device-name-input" required>
                </div>
                <div class="form-group">
                    <label>åº”ç”¨åç§° (App) *</label>
                    <input type="text" id="device-app-input" placeholder="ä¾‹å¦‚: roborock" required>
                </div>
                <div class="form-group">
                    <label>æ“ä½œé…ç½® (Actions) *</label>
                    <div id="actions-container"></div>
                    <button type="button" class="add-action-btn" onclick="addActionRow()">+ æ·»åŠ æ“ä½œ</button>
                </div>
                <div class="form-group">
                    <label>å›¾æ ‡</label>
                    <select id="device-icon-input">
                        <option value="">é€‰æ‹©å›¾æ ‡...</option>
                    </select>
                    <div class="icon-preview" id="icon-preview"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="closeDeviceModal()">å–æ¶ˆ</button>
                    <button type="submit" class="modal-btn save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5001';
        let cleaningEventSource = null;
        let isCleaning = false;
        let currentEditingDeviceId = null;
        let phoneScreenInterval = null;
        let isPhoneScreenActive = false;
        let logEventSource = null;  // å…¨å±€æ—¥å¿—æµè¿æ¥

        // é¡µé¢åˆ‡æ¢
        function switchPage(page) {
            const controlPanelPage = document.getElementById('control-panel-page');
            const scheduleManagementPage = document.getElementById('schedule-management-page');
            const deviceManagementPage = document.getElementById('device-management-page');
            const navControlPanel = document.getElementById('nav-control-panel');
            const navScheduleManagement = document.getElementById('nav-schedule-management');
            const navDeviceManagement = document.getElementById('nav-device-management');

            // éšè—æ‰€æœ‰é¡µé¢
            controlPanelPage.style.display = 'none';
            scheduleManagementPage.style.display = 'none';
            deviceManagementPage.style.display = 'none';
            
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            navControlPanel.classList.remove('active');
            navScheduleManagement.classList.remove('active');
            navDeviceManagement.classList.remove('active');

            if (page === 'control-panel') {
                controlPanelPage.style.display = 'block';
                navControlPanel.classList.add('active');
                loadDevices();
            } else if (page === 'schedule-management') {
                scheduleManagementPage.style.display = 'block';
                navScheduleManagement.classList.add('active');
                loadScheduleList();
            } else if (page === 'device-management') {
                deviceManagementPage.style.display = 'block';
                navDeviceManagement.classList.add('active');
                loadDeviceManagementList();
            }
        }

        // é¡¶éƒ¨å¯¼èˆªèœå•ç‚¹å‡»äº‹ä»¶
        document.getElementById('nav-control-panel').addEventListener('click', () => {
            switchPage('control-panel');
        });
        
        document.getElementById('nav-schedule-management').addEventListener('click', () => {
            switchPage('schedule-management');
        });
        
        document.getElementById('nav-device-management').addEventListener('click', () => {
            switchPage('device-management');
        });

        // åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼ˆæ§åˆ¶é¢æ¿ï¼‰
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/devices`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderDevices(data.devices);
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è®¾å¤‡å¡ç‰‡
        function renderDevices(devices) {
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = '';

            devices.forEach(device => {
                const card = document.createElement('div');
                card.className = 'device-card';
                card.id = `device-card-${device.id}`;
                // ç§»é™¤å¡ç‰‡ç‚¹å‡»äº‹ä»¶

                // åˆ¤æ–­æ˜¯å›¾æ ‡æ–‡ä»¶è¿˜æ˜¯ emoji
                let iconHtml = '';
                if (device.icon && device.icon.includes('.')) {
                    // æ˜¯å›¾æ ‡æ–‡ä»¶
                    iconHtml = `<img src="${API_BASE_URL}/api/icons/${device.icon}" alt="${device.name}" class="device-icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"><span class="device-icon-emoji" style="display:none;">ğŸ“±</span>`;
                } else {
                    // æ˜¯ emojiï¼ˆå‘åå…¼å®¹ï¼‰
                    iconHtml = `<span class="device-icon-emoji">${device.icon || 'ğŸ“±'}</span>`;
                }

                // ç”Ÿæˆæ“ä½œæŒ‰é’®
                let actionsHtml = '';
                if (device.actions && device.actions.length > 0) {
                    actionsHtml = '<div class="device-actions">';
                    device.actions.forEach(action => {
                        actionsHtml += `<button class="device-action-btn" onclick="executeDeviceAction('${device.id}', '${action.id}')" id="action-btn-${device.id}-${action.id}">${action.name}</button>`;
                    });
                    actionsHtml += '</div>';
                } else {
                    // å¦‚æœæ²¡æœ‰é…ç½® actionsï¼Œä½¿ç”¨é»˜è®¤çš„ commandï¼ˆå‘åå…¼å®¹ï¼‰
                    actionsHtml = '<div class="device-actions"><button class="device-action-btn" onclick="executeDeviceAction(\'' + device.id + '\', null)">æ‰§è¡Œ</button></div>';
                }

                card.innerHTML = `
                    <div class="device-header">
                        <div class="device-header-left">
                            <div>${iconHtml}</div>
                            ${device.app ? `<div class="device-app-name">${device.app}</div>` : ''}
                        </div>
                        <div class="device-status" id="device-status-${device.id}">${device.status || 'å¾…æœº'}</div>
                    </div>
                    <div class="device-name">${device.name}</div>
                    <div class="device-info" id="device-info-${device.id}">é€‰æ‹©æ“ä½œ</div>
                    ${actionsHtml}
                `;

                grid.appendChild(card);
            });
        }

        // åŠ è½½è®¾å¤‡ç®¡ç†åˆ—è¡¨
        async function loadDeviceManagementList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/devices`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderDeviceManagementList(data.devices);
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è®¾å¤‡ç®¡ç†åˆ—è¡¨
        function renderDeviceManagementList(devices) {
            const list = document.getElementById('device-management-list');
            list.innerHTML = '';

            if (devices.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— è®¾å¤‡ï¼Œç‚¹å‡»"æ·»åŠ è®¾å¤‡"æŒ‰é’®æ·»åŠ </div>';
                return;
            }

            devices.forEach(device => {
                const item = document.createElement('div');
                item.className = 'device-management-item';
                item.innerHTML = `
                    <div class="device-management-info">
                        <div class="device-management-name">
                            ${device.icon && device.icon.includes('.') 
                                ? `<img src="${API_BASE_URL}/api/icons/${device.icon}" alt="${device.name}" style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"><span style="display:none;">ğŸ“±</span>` 
                                : `<span>${device.icon || 'ğŸ“±'}</span>`}
                            <span>${device.name}</span>
                        </div>
                        <div class="device-management-details">
                            <div>åº”ç”¨: ${device.app || 'æœªè®¾ç½®'}</div>
                            <div>æ“ä½œæ•°: ${device.actions && device.actions.length ? device.actions.length + ' ä¸ª' : '0 ä¸ª'}</div>
                            ${device.actions && device.actions.length > 0 
                                ? `<div style="margin-top: 4px; font-size: 12px;">æ“ä½œ: ${device.actions.map(a => a.name).join(', ')}</div>` 
                                : ''}
                        </div>
                    </div>
                    <div class="device-management-actions">
                        <button class="action-btn edit" onclick="editDevice('${device.id}')">ç¼–è¾‘</button>
                        <button class="action-btn delete" onclick="deleteDevice('${device.id}')">åˆ é™¤</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // åŠ è½½å›¾æ ‡åˆ—è¡¨
        async function loadIcons() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/icons`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const select = document.getElementById('device-icon-input');
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"é€‰æ‹©å›¾æ ‡..."ï¼‰
                    select.innerHTML = '<option value="">é€‰æ‹©å›¾æ ‡...</option>';
                    
                    // æ·»åŠ å›¾æ ‡é€‰é¡¹
                    data.icons.forEach(icon => {
                        const option = document.createElement('option');
                        option.value = icon;
                        option.textContent = icon;
                        select.appendChild(option);
                    });
                    
                    // æ·»åŠ å›¾æ ‡é¢„è§ˆåŠŸèƒ½
                    select.addEventListener('change', (e) => {
                        const preview = document.getElementById('icon-preview');
                        if (e.target.value) {
                            preview.innerHTML = `<img src="${API_BASE_URL}/api/icons/${e.target.value}" alt="é¢„è§ˆ" onerror="this.parentElement.innerHTML='';">`;
                        } else {
                            preview.innerHTML = '';
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å›¾æ ‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æ“ä½œè¡Œ
        function addActionRow(action = null) {
            const container = document.getElementById('actions-container');
            const row = document.createElement('div');
            row.className = 'action-row';
            const actionId = action ? action.id : `action_${Date.now()}`;
            row.innerHTML = `
                <input type="text" class="action-name-input" placeholder="æ“ä½œåç§°" value="${action ? action.name : ''}" required>
                <textarea class="action-command-input" placeholder="ä¾‹å¦‚: æ‰“å¼€{app}åº”ç”¨ï¼Œå¯åŠ¨æ‰«åœ°æœºå…¨å±‹æ¸…æ‰«" required>${action ? action.command : ''}</textarea>
                <button type="button" class="remove-action-btn" onclick="removeActionRow(this)">åˆ é™¤</button>
            `;
            container.appendChild(row);
        }

        // åˆ é™¤æ“ä½œè¡Œ
        function removeActionRow(btn) {
            btn.parentElement.remove();
        }

        // æ˜¾ç¤ºæ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        async function showAddDeviceModal() {
            currentEditingDeviceId = null;
            document.getElementById('device-modal-title').textContent = 'æ·»åŠ è®¾å¤‡';
            document.getElementById('device-form').reset();
            document.getElementById('device-id-input').value = '';
            document.getElementById('icon-preview').innerHTML = '';
            document.getElementById('actions-container').innerHTML = '';
            // é»˜è®¤æ·»åŠ ä¸€ä¸ªç©ºçš„æ“ä½œè¡Œ
            addActionRow();
            await loadIcons();
            document.getElementById('device-modal').classList.add('show');
        }

        // ç¼–è¾‘è®¾å¤‡
        async function editDevice(deviceId) {
            try {
                await loadIcons();
                
                const response = await fetch(`${API_BASE_URL}/api/devices`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const device = data.devices.find(d => d.id === deviceId);
                    if (device) {
                        currentEditingDeviceId = deviceId;
                        document.getElementById('device-modal-title').textContent = 'ç¼–è¾‘è®¾å¤‡';
                        document.getElementById('device-id-input').value = device.id;
                        document.getElementById('device-name-input').value = device.name;
                        document.getElementById('device-app-input').value = device.app || '';
                        document.getElementById('device-icon-input').value = device.icon || '';
                        
                        // æ¸…ç©ºå¹¶é‡æ–°åŠ è½½ actions
                        const actionsContainer = document.getElementById('actions-container');
                        actionsContainer.innerHTML = '';
                        if (device.actions && device.actions.length > 0) {
                            device.actions.forEach(action => {
                                addActionRow(action);
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰ actionsï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¡Œ
                            addActionRow();
                        }
                        
                        // æ˜¾ç¤ºå›¾æ ‡é¢„è§ˆ
                        const preview = document.getElementById('icon-preview');
                        if (device.icon && device.icon.includes('.')) {
                            preview.innerHTML = `<img src="${API_BASE_URL}/api/icons/${device.icon}" alt="é¢„è§ˆ" onerror="this.parentElement.innerHTML='';">`;
                        } else {
                            preview.innerHTML = '';
                        }
                        
                        document.getElementById('device-modal').classList.add('show');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½è®¾å¤‡ä¿¡æ¯å¤±è´¥');
            }
        }

        // åˆ é™¤è®¾å¤‡
        async function deleteDevice(deviceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/devices/${deviceId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    alert('è®¾å¤‡åˆ é™¤æˆåŠŸ');
                    loadDeviceManagementList();
                    loadDevices(); // åŒæ—¶æ›´æ–°æ§åˆ¶é¢æ¿
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error);
                alert('åˆ é™¤è®¾å¤‡å¤±è´¥');
            }
        }

        // å…³é—­è®¾å¤‡æ¨¡æ€æ¡†
        function closeDeviceModal() {
            document.getElementById('device-modal').classList.remove('show');
            document.getElementById('actions-container').innerHTML = '';
            currentEditingDeviceId = null;
        }

        // ä¿å­˜è®¾å¤‡
        document.getElementById('device-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const iconValue = document.getElementById('device-icon-input').value;
            
            // æ”¶é›†æ‰€æœ‰ actions
            const actionRows = document.querySelectorAll('.action-row');
            const actions = [];
            actionRows.forEach((row, index) => {
                const nameInput = row.querySelector('.action-name-input');
                const commandInput = row.querySelector('.action-command-input');
                if (nameInput.value.trim() && commandInput.value.trim()) {
                    actions.push({
                        id: `action_${index}`,
                        name: nameInput.value.trim(),
                        command: commandInput.value.trim()
                    });
                }
            });

            if (actions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ“ä½œ');
                return;
            }

            const deviceData = {
                name: document.getElementById('device-name-input').value,
                app: document.getElementById('device-app-input').value,
                actions: actions,
                icon: iconValue || 'ğŸ“±', // å¦‚æœæ²¡æœ‰é€‰æ‹©å›¾æ ‡æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤ emoji
                status: 'å¾…æœº'
            };

            try {
                let response;
                if (currentEditingDeviceId) {
                    // æ›´æ–°è®¾å¤‡
                    response = await fetch(`${API_BASE_URL}/api/devices/${currentEditingDeviceId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(deviceData)
                    });
                } else {
                    // æ·»åŠ è®¾å¤‡
                    deviceData.id = `device_${Date.now()}`;
                    response = await fetch(`${API_BASE_URL}/api/devices`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(deviceData)
                    });
                }

                const data = await response.json();

                if (data.status === 'success') {
                    alert(currentEditingDeviceId ? 'è®¾å¤‡æ›´æ–°æˆåŠŸ' : 'è®¾å¤‡æ·»åŠ æˆåŠŸ');
                    closeDeviceModal();
                    loadDeviceManagementList();
                    loadDevices(); // åŒæ—¶æ›´æ–°æ§åˆ¶é¢æ¿
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('ä¿å­˜è®¾å¤‡å¤±è´¥:', error);
                alert('ä¿å­˜è®¾å¤‡å¤±è´¥');
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('device-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeDeviceModal();
            }
        });

        // åˆ‡æ¢æ‰‹æœºå±å¹•æ˜¾ç¤º
        function togglePhoneScreen() {
            const toggleBtn = document.getElementById('phone-screen-toggle');
            const toggleText = document.getElementById('phone-screen-toggle-text');
            const container = document.getElementById('phone-screen-container');
            const placeholder = document.getElementById('phone-screen-placeholder');

            if (isPhoneScreenActive) {
                // åœæ­¢æ˜¾ç¤º
                isPhoneScreenActive = false;
                if (phoneScreenInterval) {
                    clearInterval(phoneScreenInterval);
                    phoneScreenInterval = null;
                }
                container.classList.remove('show');
                placeholder.style.display = 'flex';
                toggleText.textContent = 'å¼€å§‹';
                toggleBtn.disabled = false;
            } else {
                // å¼€å§‹æ˜¾ç¤º
                isPhoneScreenActive = true;
                container.classList.add('show');
                placeholder.style.display = 'none';
                toggleText.textContent = 'åœæ­¢';
                toggleBtn.disabled = true;
                
                // ç«‹å³è·å–ä¸€æ¬¡
                updatePhoneScreen();
                
                // æ¯2ç§’æ›´æ–°ä¸€æ¬¡å±å¹•æˆªå›¾
                phoneScreenInterval = setInterval(updatePhoneScreen, 2000);
            }
        }

        // æ›´æ–°æ‰‹æœºå±å¹•æˆªå›¾
        async function updatePhoneScreen() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/phone-screen`);
                const data = await response.json();
                
                if (data.status === 'success' && data.screenshot) {
                    const screenImage = document.getElementById('phone-screen-image');
                    screenImage.src = data.screenshot;
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    const toggleBtn = document.getElementById('phone-screen-toggle');
                    toggleBtn.disabled = false;
                } else {
                    // å¦‚æœå¤±è´¥ï¼Œåœæ­¢æ›´æ–°
                    if (isPhoneScreenActive) {
                        togglePhoneScreen();
                    }
                }
            } catch (error) {
                console.error('è·å–æ‰‹æœºå±å¹•å¤±è´¥:', error);
                // å¦‚æœå¤±è´¥ï¼Œåœæ­¢æ›´æ–°
                if (isPhoneScreenActive) {
                    togglePhoneScreen();
                }
            }
        }

        // æ£€æµ‹æ§åˆ¶è®¾å¤‡çŠ¶æ€
        async function checkControlDevice() {
            const refreshBtn = document.getElementById('refresh-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const deviceDetails = document.getElementById('device-details');

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="loading-spinner"></span><span>æ£€æµ‹ä¸­...</span>';
            statusText.textContent = 'æ­£åœ¨æ£€æµ‹è®¾å¤‡çŠ¶æ€...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/check-adb-device`);
                const data = await response.json();

                if (data.status === 'success') {
                    if (data.connected) {
                        // è®¾å¤‡å·²è¿æ¥
                        statusIndicator.className = 'status-indicator connected';
                        statusText.textContent = `å·²è¿æ¥ (${data.device_count} ä¸ªè®¾å¤‡)`;
                        
                        // æ˜¾ç¤ºè®¾å¤‡è¯¦æƒ…
                        if (data.devices && data.devices.length > 0) {
                            const deviceList = data.devices
                                .filter(d => d.status === 'device')
                                .map(d => `è®¾å¤‡ID: ${d.device_id}`)
                                .join('<br>');
                            deviceDetails.innerHTML = deviceList;
                        } else {
                            deviceDetails.textContent = '';
                        }
                    } else {
                        // è®¾å¤‡æœªè¿æ¥
                        statusIndicator.className = 'status-indicator disconnected';
                        statusText.textContent = 'æœªè¿æ¥';
                        deviceDetails.textContent = data.message || 'æœªæ£€æµ‹åˆ°å·²è¿æ¥çš„è®¾å¤‡';
                    }
                } else {
                    // æ£€æµ‹å¤±è´¥
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'æ£€æµ‹å¤±è´¥';
                    deviceDetails.textContent = data.message || data.error || 'æœªçŸ¥é”™è¯¯';
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'è¿æ¥å¤±è´¥';
                deviceDetails.textContent = 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<span>ğŸ”„</span><span>åˆ·æ–°</span>';
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            const streamOutput = document.getElementById('stream-output');
            streamOutput.innerHTML = '';
        }

        // æ›´æ–°è®¾å¤‡çŠ¶æ€
        async function updateDeviceStatus(deviceId, status, info) {
            const statusEl = document.getElementById(`device-status-${deviceId}`);
            const infoEl = document.getElementById(`device-info-${deviceId}`);
            const cardEl = document.getElementById(`device-card-${deviceId}`);

            if (statusEl) statusEl.textContent = status;
            
            // æ›´æ–° info
            if (infoEl) {
                infoEl.textContent = info;
            }

            if (cardEl) {
                if (status === 'æ‰§è¡Œä¸­') {
                    cardEl.classList.add('cleaning');
                    if (statusEl) statusEl.classList.add('active');
                } else {
                    cardEl.classList.remove('cleaning');
                    if (statusEl) statusEl.classList.remove('active');
                }
            }
        }

        // è¿½åŠ æµå¼è¾“å‡º
        function appendStreamOutput(data) {
            const outputDiv = document.getElementById('stream-output');
            let className = 'line';
            let prefix = '';

            if (data.type === 'start') {
                className += ' info';
                prefix = '[å¼€å§‹] ';
                
                // å¦‚æœæœ‰ final_commandï¼Œæ˜¾ç¤ºæœ€ç»ˆè°ƒç”¨çš„å‘½ä»¤
                if (data.final_command) {
                    const commandDiv = document.createElement('div');
                    commandDiv.className = 'line info';
                    commandDiv.style.fontWeight = 'bold';
                    commandDiv.style.marginTop = '4px';
                    commandDiv.style.marginBottom = '4px';
                    commandDiv.textContent = `[æœ€ç»ˆå‘½ä»¤] ${data.final_command}`;
                    outputDiv.appendChild(commandDiv);
                }
            } else if (data.type === 'output') {
                className += ' info';
            } else if (data.type === 'end') {
                if (data.status === 'success') {
                    className += ' success';
                    prefix = '[å®Œæˆ] ';
                } else {
                    className += ' error';
                    prefix = '[å¤±è´¥] ';
                }
            } else if (data.type === 'error') {
                className += ' error';
                prefix = '[é”™è¯¯] ';
            } else if (data.type === 'voice') {
                className += ' info';
                prefix = '[è¯­éŸ³] ';
            } else if (data.type === 'match') {
                className += ' success';
                prefix = '[åŒ¹é…] ';
            } else if (data.type === 'warning') {
                className += ' error';
                prefix = '[è­¦å‘Š] ';
            } else if (data.type === 'success') {
                className += ' success';
                prefix = '[æˆåŠŸ] ';
            } else if (data.type === 'connected') {
                className += ' info';
                prefix = '[è¿æ¥] ';
            } else if (data.type === 'heartbeat') {
                // å¿ƒè·³æ¶ˆæ¯ï¼Œä¸æ˜¾ç¤º
                return;
            }

            const lineDiv = document.createElement('div');
            lineDiv.className = className;

            if (data.line) {
                lineDiv.textContent = prefix + data.line;
            } else if (data.message) {
                lineDiv.textContent = prefix + data.message;
            } else if (data.error) {
                lineDiv.textContent = prefix + data.error;
            }

            // æ·»åŠ æ—¶é—´æˆ³ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.timestamp) {
                const timeSpan = document.createElement('span');
                timeSpan.style.color = '#666';
                timeSpan.style.fontSize = '10px';
                timeSpan.style.marginLeft = '8px';
                timeSpan.textContent = data.timestamp;
                lineDiv.appendChild(timeSpan);
            }

            outputDiv.appendChild(lineDiv);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        // è¿æ¥å…¨å±€æ—¥å¿—æµ
        function connectLogStream() {
            if (logEventSource) {
                logEventSource.close();
            }

            logEventSource = new EventSource(`${API_BASE_URL}/api/logs/stream`);

            logEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    appendStreamOutput(data);
                } catch (e) {
                    console.error('è§£ææ—¥å¿— JSON å¤±è´¥:', e, event.data);
                }
            };

            logEventSource.onerror = function(error) {
                console.error('æ—¥å¿—æµè¿æ¥é”™è¯¯:', error);
                // 3ç§’åé‡è¿
                setTimeout(() => {
                    if (logEventSource && logEventSource.readyState === EventSource.CLOSED) {
                        connectLogStream();
                    }
                }, 3000);
            };
        }

        // æ‰§è¡Œè®¾å¤‡æ“ä½œ
        async function executeDeviceAction(deviceId, actionId) {
            if (isCleaning) {
                return;
            }

            isCleaning = true;
            updateDeviceStatus(deviceId, 'æ‰§è¡Œä¸­', 'æ­£åœ¨å¯åŠ¨...');
            
            // ç¦ç”¨æ‰€æœ‰æ“ä½œæŒ‰é’®
            const actionButtons = document.querySelectorAll(`[id^="action-btn-${deviceId}-"]`);
            actionButtons.forEach(btn => btn.disabled = true);
            
            // å®šä¹‰æ¢å¤æŒ‰é’®çš„å‡½æ•°
            const restoreButtons = () => {
                actionButtons.forEach(btn => btn.disabled = false);
            };
            
            // è·å–è®¾å¤‡ä¿¡æ¯å¹¶æ›´æ–°æ—¥å¿—æ ‡é¢˜
            try {
                const devicesResponse = await fetch(`${API_BASE_URL}/api/devices`);
                const devicesData = await devicesResponse.json();
                const device = devicesData.devices.find(d => d.id === deviceId);
                
                if (device) {
                    const titleEl = document.getElementById('log-title');
                    let actionName = '';
                    if (actionId && device.actions) {
                        const action = device.actions.find(a => a.id === actionId);
                        if (action) {
                            actionName = ` - ${action.name}`;
                        }
                    }
                    
                    if (device.icon && device.icon.includes('.')) {
                        // ä½¿ç”¨å›¾æ ‡æ–‡ä»¶
                        titleEl.innerHTML = `<img src="${API_BASE_URL}/api/icons/${device.icon}" alt="${device.name}" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"><span style="display:none;">ğŸ“±</span> ${device.name}${actionName}`;
                    } else {
                        // ä½¿ç”¨ emoji
                        titleEl.textContent = `${device.icon || 'ğŸ“±'} ${device.name}${actionName}`;
                    }
                } else {
                    document.getElementById('log-title').textContent = 'æ‰§è¡Œæ—¥å¿—';
                }
            } catch (e) {
                console.error('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', e);
            }
            
            // æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
            const streamOutput = document.getElementById('stream-output');
            streamOutput.innerHTML = '';

            // å¦‚æœå·²ç»æœ‰è¿æ¥åœ¨è¿è¡Œï¼Œå…ˆå…³é—­
            if (cleaningEventSource) {
                cleaningEventSource.close();
                cleaningEventSource = null;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/devices/${deviceId}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action_id: actionId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                appendStreamOutput(data);

                                // å¦‚æœæ”¶åˆ°ç»“æŸæ¶ˆæ¯
                                if (data.type === 'end' || data.type === 'error') {
                                    isCleaning = false;
                                    restoreButtons();
                                    
                                    if (data.status === 'success') {
                                        updateDeviceStatus(deviceId, 'å¾…æœº', 'æ‰§è¡Œå®Œæˆ');
                                    } else {
                                        updateDeviceStatus(deviceId, 'å¾…æœº', 'æ‰§è¡Œå¤±è´¥');
                                    }
                                } else if (data.type === 'start') {
                                    updateDeviceStatus(deviceId, 'æ‰§è¡Œä¸­', 'æ­£åœ¨æ‰§è¡Œå‘½ä»¤...');
                                }
                            } catch (e) {
                                console.error('è§£æ JSON å¤±è´¥:', e, line);
                            }
                        }
                    }
                }
            } catch (error) {
                isCleaning = false;
                restoreButtons();
                updateDeviceStatus(deviceId, 'å¾…æœº', 'è¿æ¥å¤±è´¥');
                appendStreamOutput({
                    type: 'error',
                    error: 'è¿æ¥å¤±è´¥ï¼š' + error.message
                });
            }
        }

        // ==================== å®šæ—¶ä»»åŠ¡ç®¡ç† ====================
        
        // åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨
        async function loadScheduleList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderScheduleList(data.schedules);
                }
            } catch (error) {
                console.error('åŠ è½½å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å®šæ—¶ä»»åŠ¡åˆ—è¡¨
        function renderScheduleList(schedules) {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '';

            if (schedules.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— å®šæ—¶ä»»åŠ¡</div>';
                return;
            }

            schedules.forEach(schedule => {
                const item = document.createElement('div');
                item.className = 'device-management-item';
                
                const repeatText = getRepeatText(schedule.repeat, schedule.weekdays);
                const statusBadge = schedule.enabled 
                    ? '<span style="color: #52c41a;">â—</span> å·²å¯ç”¨' 
                    : '<span style="color: #999;">â—</span> å·²ç¦ç”¨';
                
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">
                            ${schedule.name}
                        </div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                            è®¾å¤‡: ${schedule.device_name} - ${schedule.action_name}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            æ—¶é—´: ${schedule.time} | ${repeatText} | ${statusBadge}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn edit" onclick="editSchedule('${schedule.id}')">
                            <span>âœï¸</span>
                            <span>ç¼–è¾‘</span>
                        </button>
                        <button class="action-btn delete" onclick="deleteSchedule('${schedule.id}')">
                            <span>ğŸ—‘ï¸</span>
                            <span>åˆ é™¤</span>
                        </button>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }

        // è·å–é‡å¤æ‰§è¡Œæ–‡æœ¬
        function getRepeatText(repeat, weekdays) {
            const repeatMap = {
                'once': 'ä»…ä¸€æ¬¡',
                'daily': 'æ¯å¤©',
                'weekly': 'æ¯å‘¨',
                'weekdays': 'å·¥ä½œæ—¥',
                'weekends': 'å‘¨æœ«'
            };
            
            if (repeat === 'weekly' && weekdays && weekdays.length > 0) {
                const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                return weekdays.map(d => dayNames[d]).join('ã€');
            }
            
            return repeatMap[repeat] || repeat;
        }

        // æ˜¾ç¤ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†
        async function showAddScheduleModal() {
            document.getElementById('schedule-modal-title').textContent = 'æ·»åŠ å®šæ—¶ä»»åŠ¡';
            document.getElementById('schedule-form').reset();
            document.getElementById('schedule-id-input').value = '';
            document.getElementById('schedule-enabled-input').checked = true;
            document.getElementById('weekday-selector').style.display = 'none';
            
            // åŠ è½½è®¾å¤‡åˆ—è¡¨
            await loadDeviceSelectOptions();
            
            document.getElementById('schedule-modal').style.display = 'flex';
        }

        // åŠ è½½è®¾å¤‡é€‰æ‹©é€‰é¡¹
        async function loadDeviceSelectOptions() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/devices`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const select = document.getElementById('schedule-device-select');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©è®¾å¤‡...</option>';
                    
                    data.devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = device.name;
                        option.dataset.actions = JSON.stringify(device.actions);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½è®¾å¤‡çš„æ“ä½œé€‰é¡¹
        function loadDeviceActions() {
            const deviceSelect = document.getElementById('schedule-device-select');
            const actionSelect = document.getElementById('schedule-action-select');
            
            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                actionSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©è®¾å¤‡...</option>';
                return;
            }
            
            const actions = JSON.parse(selectedOption.dataset.actions || '[]');
            
            actionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ“ä½œ...</option>';
            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.id;
                option.textContent = action.name;
                actionSelect.appendChild(option);
            });
        }

        // ç›‘å¬é‡å¤æ‰§è¡Œé€‰æ‹©å˜åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const repeatSelect = document.getElementById('schedule-repeat-input');
            if (repeatSelect) {
                repeatSelect.addEventListener('change', (e) => {
                    const weekdaySelector = document.getElementById('weekday-selector');
                    if (e.target.value === 'weekly') {
                        weekdaySelector.style.display = 'block';
                    } else {
                        weekdaySelector.style.display = 'none';
                    }
                });
            }
        });

        // ç¼–è¾‘å®šæ—¶ä»»åŠ¡
        async function editSchedule(scheduleId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const schedule = data.schedules.find(s => s.id === scheduleId);
                    if (schedule) {
                        document.getElementById('schedule-modal-title').textContent = 'ç¼–è¾‘å®šæ—¶ä»»åŠ¡';
                        document.getElementById('schedule-id-input').value = schedule.id;
                        document.getElementById('schedule-name-input').value = schedule.name;
                        document.getElementById('schedule-time-input').value = schedule.time;
                        document.getElementById('schedule-repeat-input').value = schedule.repeat;
                        document.getElementById('schedule-enabled-input').checked = schedule.enabled;
                        
                        // åŠ è½½è®¾å¤‡åˆ—è¡¨
                        await loadDeviceSelectOptions();
                        
                        // è®¾ç½®é€‰ä¸­çš„è®¾å¤‡
                        document.getElementById('schedule-device-select').value = schedule.device_id;
                        
                        // åŠ è½½æ“ä½œåˆ—è¡¨
                        loadDeviceActions();
                        
                        // è®¾ç½®é€‰ä¸­çš„æ“ä½œ
                        setTimeout(() => {
                            document.getElementById('schedule-action-select').value = schedule.action_id;
                        }, 100);
                        
                        // å¤„ç†æ˜ŸæœŸå‡ é€‰æ‹©
                        if (schedule.repeat === 'weekly' && schedule.weekdays) {
                            document.getElementById('weekday-selector').style.display = 'block';
                            const checkboxes = document.querySelectorAll('input[name="weekday"]');
                            checkboxes.forEach(cb => {
                                cb.checked = schedule.weekdays.includes(parseInt(cb.value));
                            });
                        }
                        
                        document.getElementById('schedule-modal').style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å®šæ—¶ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // åˆ é™¤å®šæ—¶ä»»åŠ¡
        async function deleteSchedule(scheduleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    loadScheduleList();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­å®šæ—¶ä»»åŠ¡æ¨¡æ€æ¡†
        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
        }

        // ä¿å­˜å®šæ—¶ä»»åŠ¡
        document.addEventListener('DOMContentLoaded', () => {
            const scheduleForm = document.getElementById('schedule-form');
            if (scheduleForm) {
                scheduleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const scheduleId = document.getElementById('schedule-id-input').value;
                    const name = document.getElementById('schedule-name-input').value;
                    const deviceId = document.getElementById('schedule-device-select').value;
                    const actionId = document.getElementById('schedule-action-select').value;
                    const time = document.getElementById('schedule-time-input').value;
                    const repeat = document.getElementById('schedule-repeat-input').value;
                    const enabled = document.getElementById('schedule-enabled-input').checked;
                    
                    // è·å–é€‰ä¸­çš„æ˜ŸæœŸå‡ 
                    let weekdays = [];
                    if (repeat === 'weekly') {
                        const checkboxes = document.querySelectorAll('input[name="weekday"]:checked');
                        weekdays = Array.from(checkboxes).map(cb => parseInt(cb.value));
                        
                        if (weekdays.length === 0) {
                            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ˜ŸæœŸå‡ ');
                            return;
                        }
                    }
                    
                    const scheduleData = {
                        name,
                        device_id: deviceId,
                        action_id: actionId,
                        time,
                        repeat,
                        weekdays,
                        enabled
                    };
                    
                    try {
                        const url = scheduleId 
                            ? `${API_BASE_URL}/api/schedules/${scheduleId}`
                            : `${API_BASE_URL}/api/schedules`;
                        const method = scheduleId ? 'PUT' : 'POST';
                        
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(scheduleData)
                        });
                        
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            closeScheduleModal();
                            loadScheduleList();
                        } else {
                            alert('ä¿å­˜å¤±è´¥: ' + data.message);
                        }
                    } catch (error) {
                        console.error('ä¿å­˜å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
                        alert('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                });
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            // è¿æ¥å…¨å±€æ—¥å¿—æµ
            connectLogStream();
        });

    </script>
</body>
</html>
